# OWASP ZAP DAST Workflow
# Dynamic Application Security Testing for preview environments
# Runs on PRs with 'preview' label or manually

name: DAST Security Scan

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to scan'
        required: true
        default: 'http://localhost:3000'
      scan_type:
        description: 'Scan type (baseline, full, api)'
        required: true
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full
          - api

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: write

jobs:
  zap-scan:
    name: OWASP ZAP DAST
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'preview')

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: agentkern_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: |
          cd apps/identity
          pnpm install --frozen-lockfile

      - name: Build application
        run: |
          cd apps/identity
          pnpm build

      - name: Start application
        run: |
          cd apps/identity
          DATABASE_URL="postgres://test:test@localhost:5432/agentkern_test" \
          NODE_ENV=test \
          pnpm start:prod &
          sleep 10

      - name: Wait for application
        run: |
          timeout 60 bash -c 'until curl -s http://localhost:3000/health; do sleep 2; done'

      - name: ZAP Baseline Scan
        if: github.event.inputs.scan_type == 'baseline' || github.event_name == 'pull_request'
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.github/zap-rules.tsv'
          fail_action: false
          allow_issue_writing: true
          artifact_name: 'zap-baseline-report'

      - name: ZAP Full Scan
        if: github.event.inputs.scan_type == 'full'
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.github/zap-rules.tsv'
          fail_action: false
          allow_issue_writing: true
          artifact_name: 'zap-full-report'

      - name: ZAP API Scan
        if: github.event.inputs.scan_type == 'api'
        uses: zaproxy/action-api-scan@v0.9.0
        with:
          target: 'http://localhost:3000/api/docs-json'
          format: openapi
          fail_action: false
          allow_issue_writing: true
          artifact_name: 'zap-api-report'

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'zap-scan-results.sarif'
        continue-on-error: true
