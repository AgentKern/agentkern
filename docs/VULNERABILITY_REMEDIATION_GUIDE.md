# Vulnerability Remediation & Security Best Practices

This guide provides developers with clear instructions on how to handle security findings and implement secure alternatives for common vulnerabilities.

## 1. Injection Vulnerabilities

### SQL Injection
**Vulnerable Code:**
```typescript
// Querying without parameterization
const users = await repository.query(`SELECT * FROM users WHERE id = '${id}'`);
```
**Secure Alternative:**
```typescript
// Use TypeORM find or parameterized query
const users = await repository.findOneBy({ id: id });
```

### Prompt Injection
**Vulnerable Logic:**
```rust
// Directly passing user input to LLM
let prompt = format!("Summarize this: {}", user_input);
```
**Secure Alternative:**
```rust
// Use AgentKern-Gate PromptGuard
let guard = PromptGuard::new();
if guard.should_block(&user_input) {
    return Err(Error::MaliciousPrompt);
}
let prompt = format!("Summarize this: {}", user_input);
```

## 2. Broken Access Control

### Insecure Direct Object Reference (IDOR)
**Vulnerable Code:**
```typescript
@Get(':id')
findOne(@Param('id') id: string) {
  return this.service.findOne(id); // Returns any ID without checking owner
}
```
**Secure Alternative:**
```typescript
@Get(':id')
@UseGuards(OwnershipGuard) // Enforce ownership check
findOne(@Param('id') id: string, @Req() req) {
  return this.service.findOneByOwner(id, req.user.id);
}
```

## 3. Sensitive Data Exposure

### Handling Secrets
**Never**: Hardcode secrets or commit `.env` files.
**Always**: Use `ConfigService` and environment variables.

### Logging
**Never**: Log PII, passwords, or tokens.
**Always**: Use structured logging and mark sensitive fields for redaction.

## 4. Cross-Site Scripting (XSS)

**Vulnerable Code:**
```typescript
// Sending raw HTML
return `<div id="${id}">${content}</div>`;
```
**Secure Alternative:**
- Use `DOMPurify` to sanitize HTML if absolutely necessary to render raw input.
- Rely on framework-level escaping (NestJS/React/Vue do this by default).

## 5. Security Headers

Ensure `helmet` is always initialized in `main.ts`:
```typescript
app.use(helmet());
```

## 6. Rate Limiting

Apply `ThrottlerGuard` to sensitive endpoints:
```typescript
@UseGuards(ThrottlerGuard)
@Post('verify')
verify() { ... }
```
