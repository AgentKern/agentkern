name: Security & Supply Chain

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '24'
  PNPM_VERSION: '9'

jobs:
  # ============================================
  # SBOM Generation (SLSA Level 3)
  # ============================================
  sbom-rust:
    name: Generate Rust SBOM
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly
      
      - name: Install cargo-sbom
        run: cargo install cargo-sbom
      
      - name: Generate SBOM for workspace
        run: |
          cargo sbom --output-format cyclone_dx_json_1_6 > agentkern-sbom.json
      
      - name: Upload Rust SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-rust
          path: agentkern-sbom.json

  # ============================================
  # TypeScript SBOM Generation
  # ============================================
  sbom-typescript:
    name: Generate TypeScript SBOM
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install CycloneDX npm
        run: npm install -g @cyclonedx/cyclonedx-npm
      
      - name: Generate SBOM for Identity
        working-directory: apps/identity
        run: |
          # Generate SBOM using CycloneDX
          # --ignore-npm-errors: Ignore npm-ls errors about optional peer dependencies
          # These are dev tools (eclint, evalmd, etc.) that aren't required at runtime
          # The SBOM will still be generated correctly from package.json and the dependency tree
          npx @cyclonedx/cyclonedx-npm \
            --spec-version 1.6 \
            --output-format JSON \
            --output-file identity-sbom.json \
            --ignore-npm-errors
      
      - name: Upload TypeScript SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-typescript
          path: |
            apps/identity/identity-sbom.json

  # ============================================
  # Vulnerability Scanning (Trivy)
  # ============================================
  vulnerability-scan:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    needs: [sbom-rust, sbom-typescript]
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Download Rust SBOMs
        uses: actions/download-artifact@v4
        with:
          name: sbom-rust
          path: sbom-rust/
      
      - name: Download TypeScript SBOMs
        uses: actions/download-artifact@v4
        with:
          name: sbom-typescript
          path: sbom-typescript/
      
      - name: Install Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  # ============================================
  # SLSA Provenance Attestation
  # ============================================
  provenance:
    name: SLSA Provenance
    runs-on: ubuntu-latest
    needs: [sbom-rust, sbom-typescript]
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      id-token: write
      contents: read
      attestations: write
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Download all SBOMs
        uses: actions/download-artifact@v4
        with:
          path: sbom/
      
      - name: Generate SLSA Provenance Attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'sbom/**/*.json'

  # ============================================
  # Sigstore/Cosign Signing
  # ============================================
  sign:
    name: Sign Artifacts
    runs-on: ubuntu-latest
    needs: [sbom-rust, sbom-typescript, provenance]
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
      
      - name: Download all SBOMs
        uses: actions/download-artifact@v4
        with:
          path: sbom/
      
      - name: Sign all SBOMs with Cosign (keyless)
        run: |
          for file in $(find sbom/ -name "*.json"); do
            echo "Signing $file"
            cosign sign-blob "$file" --output-signature "${file}.sig" --yes
          done
      
      - name: Upload signed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-signed
          path: sbom/

  # ============================================
  # Security Audit
  # ============================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-audit
        run: cargo install cargo-audit
      
      - name: Audit Rust workspace dependencies
        run: cargo audit
        continue-on-error: true
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Audit npm dependencies
        working-directory: apps/identity
        run: pnpm audit --audit-level=high
        continue-on-error: true

  # ============================================
  # SAST - Semgrep Static Analysis
  # ============================================
  semgrep-sast:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Run Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
          publishDeployment: ${{ github.repository_owner }}
          generateSarif: "1"
        env:
          SEMGREP_RULES: >
            p/default
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/typescript
            p/rust
            p/jwt
            p/sql-injection
            p/xss
            p/command-injection
      
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        if: always()

  # ============================================
  # Secret Scanning (TruffleHog)
  # ============================================
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event_name == 'pull_request' && github.event.repository.default_branch || '' }}
          head: ${{ github.event_name == 'pull_request' && 'HEAD' || '' }}
          extra_args: --only-verified

  # ============================================
  # License Compliance
  # ============================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-deny
        run: cargo install cargo-deny
      
      - name: Check licenses (workspace)
        run: cargo deny check licenses
        continue-on-error: true

  # ============================================
  # Code Quality Analysis (SonarQube)
  # ============================================
  code-quality:
    name: Code Quality (SonarQube)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run TypeScript tests with coverage
        working-directory: apps/identity
        run: pnpm test:cov || true
        continue-on-error: true
      
      - name: SonarQube Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=AgentKern_agentkern
            -Dsonar.organization=agentkern
            -Dsonar.sources=apps/identity/src
            -Dsonar.typescript.lcov.reportPaths=apps/identity/coverage/lcov.info
            -Dsonar.qualitygate.wait=true
        continue-on-error: true
      
      - name: Quality Gate Status
        run: |
          echo "## Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "SonarQube analysis complete. Check SonarCloud for details." >> $GITHUB_STEP_SUMMARY
          echo "[View Dashboard](https://sonarcloud.io/dashboard?id=AgentKern_agentkern)" >> $GITHUB_STEP_SUMMARY
