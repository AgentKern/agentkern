name: Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  PREVIEW_NAMESPACE: "preview-pr-${{ github.event.pull_request.number }}"
  CLUSTER_NAME: "agentkern-preview"

jobs:
  # ============================================
  # Deploy Ephemeral Preview Environment
  # ============================================
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Install KIND
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
      
      - name: Create KIND Cluster
        run: |
          kind create cluster --name ${{ env.CLUSTER_NAME }} --wait 60s || true
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'
      
      - name: Create Namespace
        run: |
          kubectl create namespace ${{ env.PREVIEW_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          kubectl label namespace ${{ env.PREVIEW_NAMESPACE }} \
            preview=true \
            pr=${{ github.event.pull_request.number }} \
            created-by=github-actions
      
      - name: Build Containers
        run: |
          docker build -t agentkern-gate:preview-${{ github.sha }} -f packages/pillars/gate/Dockerfile .
          kind load docker-image agentkern-gate:preview-${{ github.sha }} --name ${{ env.CLUSTER_NAME }}
      
      - name: Deploy to Preview
        run: |
          cat <<EOF | kubectl apply -n ${{ env.PREVIEW_NAMESPACE }} -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: gate
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: gate
            template:
              metadata:
                labels:
                  app: gate
              spec:
                containers:
                - name: gate
                  image: agentkern-gate:preview-${{ github.sha }}
                  ports:
                  - containerPort: 8080
                  resources:
                    limits:
                      memory: "256Mi"
                      cpu: "250m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: gate
          spec:
            selector:
              app: gate
            ports:
            - port: 80
              targetPort: 8080
          EOF
      
      - name: Wait for Deployment
        run: |
          kubectl rollout status deployment/gate -n ${{ env.PREVIEW_NAMESPACE }} --timeout=120s
      
      - name: Get Preview URL
        id: preview-url
        run: |
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
          PORT=$(kubectl get svc gate -n ${{ env.PREVIEW_NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "80")
          echo "url=http://${NODE_IP}:${PORT}" >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ **Preview Environment Ready**\n\nNamespace: \`${{ env.PREVIEW_NAMESPACE }}\`\n\n‚ö†Ô∏è This environment will be destroyed when the PR is closed.`
            });

  # ============================================
  # Cleanup on PR Close
  # ============================================
  cleanup:
    name: Cleanup Preview
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    
    steps:
      - name: Install KIND
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'
      
      - name: Delete Namespace
        run: |
          kind get clusters | grep -q ${{ env.CLUSTER_NAME }} && \
          kubectl delete namespace ${{ env.PREVIEW_NAMESPACE }} --ignore-not-found=true
          echo "‚úÖ Preview environment cleaned up"
